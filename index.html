<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wetter</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#60a5fa">
    <meta name="color-scheme" content="dark">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for the scrollbar to make it look clean */
        .hourly-scroll-container::-webkit-scrollbar {
            height: 8px;
        }
        .hourly-scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .hourly-scroll-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .hourly-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .popup-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1e293b;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 400px;
        }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center p-4">

    <div id="search-overlay" class="fixed inset-0 bg-slate-900 z-50 flex flex-col items-center p-4 transition-transform duration-300 translate-y-full">
        <div class="w-full max-w-md relative">
            <div class="flex items-center bg-slate-800 rounded-2xl p-4 shadow-lg mb-4">
                <input 
                    type="text" 
                    id="city-input" 
                    placeholder="Stadt suchen..." 
                    class="bg-transparent border-none text-white text-xl w-full focus:outline-none"
                    autocomplete="off"
                >
                <button id="close-search" class="p-2 text-slate-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div id="suggestions" class="bg-slate-800 rounded-2xl shadow-xl overflow-hidden hidden">
                </div>

            <div id="recent-searches-container" class="mt-8">
                <h3 class="text-slate-400 text-sm font-bold uppercase tracking-widest mb-4">Zuletzt gesucht</h3>
                <div id="recent-searches-list" class="space-y-2">
                    </div>
            </div>
        </div>
    </div>

    <div class="w-full max-w-md space-y-6">
        
        <header class="flex justify-between items-center px-2">
            <div id="open-search" class="flex items-center gap-2 cursor-pointer group">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-400 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <h1 id="location-name" class="text-2xl font-black tracking-tight">Lade...</h1>
            </div>
            <button id="refresh-btn" class="p-2 bg-slate-800 rounded-full hover:bg-slate-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </button>
        </header>

        <section id="current-weather" class="text-center py-8">
            <div class="flex justify-center mb-4">
                <img id="current-icon" src="" alt="Wetter Icon" class="w-40 h-40 filter drop-shadow-2xl">
            </div>
            <div class="flex flex-col items-center">
                <span id="current-temp" class="text-8xl font-black tracking-tighter leading-none mb-2">--°</span>
                <span id="weather-desc" class="text-2xl font-medium text-blue-300 capitalize">--</span>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mt-8">
                <div class="bg-slate-800/50 backdrop-blur-md p-4 rounded-3xl flex items-center gap-4">
                    <div class="bg-blue-500/20 p-2 rounded-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                        </svg>
                    </div>
                    <div class="text-left">
                        <p class="text-slate-400 text-xs font-bold uppercase">Wind</p>
                        <p id="wind-speed" class="text-lg font-bold">-- km/h</p>
                    </div>
                </div>
                <div class="bg-slate-800/50 backdrop-blur-md p-4 rounded-3xl flex items-center gap-4">
                    <div class="bg-blue-500/20 p-2 rounded-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </div>
                    <div class="text-left">
                        <p class="text-slate-400 text-xs font-bold uppercase">Feuchte</p>
                        <p id="humidity" class="text-lg font-bold">--%</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="bg-slate-800/30 rounded-3xl p-6">
            <h3 class="text-sm font-bold uppercase tracking-widest text-slate-400 mb-6">Nächste 24 Stunden</h3>
            <div id="hourly-forecast" class="flex gap-6 overflow-x-auto pb-4 hourly-scroll-container">
                </div>
        </section>

        <section class="bg-slate-800/30 rounded-3xl p-6">
            <h3 class="text-sm font-bold uppercase tracking-widest text-slate-400 mb-6">Nächste 5 Tage</h3>
            <div id="daily-forecast" class="space-y-6">
                </div>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_KEY = '59e21016896264906d4e2469950d4f95';
            let lastLocationData = null;

            // DOM Elements
            const locationNameEl = document.getElementById('location-name');
            const currentTempEl = document.getElementById('current-temp');
            const weatherDescEl = document.getElementById('weather-desc');
            const currentIconEl = document.getElementById('current-icon');
            const windSpeedEl = document.getElementById('wind-speed');
            const humidityEl = document.getElementById('humidity');
            const hourlyForecastEl = document.getElementById('hourly-forecast');
            const dailyForecastEl = document.getElementById('daily-forecast');
            const searchOverlayEl = document.getElementById('search-overlay');
            const openSearchBtn = document.getElementById('open-search');
            const closeSearchBtn = document.getElementById('close-search');
            const cityInputEl = document.getElementById('city-input');
            const suggestionsContainerEl = document.getElementById('suggestions');
            const recentSearchesListEl = document.getElementById('recent-searches-list');
            const refreshBtn = document.getElementById('refresh-btn');

            // Utilities
            const toggleSearchbar = (show) => {
                if (show) {
                    searchOverlayEl.classList.remove('translate-y-full');
                    cityInputEl.focus();
                    renderRecentCities();
                } else {
                    searchOverlayEl.classList.add('translate-y-full');
                    cityInputEl.value = '';
                    suggestionsContainerEl.classList.add('hidden');
                }
            };

            const debounce = (func, delay) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func(...args), delay);
                };
            };

            const saveRecentCities = (city) => {
                let recent = JSON.parse(localStorage.getItem('recent_cities') || '[]');
                recent = recent.filter(c => c.name !== city.name);
                recent.unshift(city);
                localStorage.setItem('recent_cities', JSON.stringify(recent.slice(0, 5)));
            };

            const renderRecentCities = () => {
                const recent = JSON.parse(localStorage.getItem('recent_cities') || '[]');
                recentSearchesListEl.innerHTML = '';
                
                if (recent.length === 0) {
                    recentSearchesListEl.innerHTML = '<p class="text-slate-500 italic">Keine alten Suchen vorhanden.</p>';
                    return;
                }

                recent.forEach(city => {
                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left p-4 bg-slate-800 rounded-2xl flex items-center justify-between hover:bg-slate-700 transition-colors';
                    btn.innerHTML = `
                        <span class="font-bold text-lg">${city.name}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    `;
                    btn.addEventListener('click', () => {
                        fetchAndProcessWeather(city);
                        toggleSearchbar(false);
                    });
                    recentSearchesListEl.appendChild(btn);
                });
            };

            async function fetchAndProcessWeather(location) {
                try {
                    lastLocationData = location;
                    localStorage.setItem('last_city', JSON.stringify(location));
                    
                    const response = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${location.lat}&lon=${location.lon}&appid=${API_KEY}&units=metric&lang=de`);
                    const data = await response.json();

                    // Current weather from the first item
                    const current = data.list[0];
                    locationNameEl.textContent = location.name;
                    currentTempEl.textContent = `${Math.round(current.main.temp)}°`;
                    weatherDescEl.textContent = current.weather[0].description;
                    currentIconEl.src = `https://openweathermap.org/img/wn/${current.weather[0].icon}@4x.png`;
                    windSpeedEl.textContent = `${Math.round(current.wind.speed * 3.6)} km/h`;
                    humidityEl.textContent = `${current.main.humidity}%`;

                    // Hourly
                    hourlyForecastEl.innerHTML = '';
                    data.list.slice(0, 8).forEach(hour => {
                        const date = new Date(hour.dt * 1000);
                        const item = document.createElement('div');
                        item.className = 'flex flex-col items-center min-w-[60px] space-y-2';
                        item.innerHTML = `
                            <span class="text-slate-400 text-sm font-bold">${date.getHours()}:00</span>
                            <img src="https://openweathermap.org/img/wn/${hour.weather[0].icon}.png" class="w-12 h-12">
                            <span class="text-lg font-black">${Math.round(hour.main.temp)}°</span>
                        `;
                        hourlyForecastEl.appendChild(item);
                    });

                    // Daily (filtering for approx 12:00 PM each day)
                    dailyForecastEl.innerHTML = '';
                    const dailyData = data.list.filter(item => item.dt_txt.includes('12:00:00'));
                    dailyData.forEach(day => {
                        const date = new Date(day.dt * 1000);
                        const dayName = date.toLocaleDateString('de-DE', { weekday: 'long' });
                        const item = document.createElement('div');
                        item.className = 'flex items-center justify-between';
                        item.innerHTML = `
                            <span class="w-24 font-bold text-lg">${dayName}</span>
                            <img src="https://openweathermap.org/img/wn/${day.weather[0].icon}.png" class="w-12 h-12">
                            <div class="flex gap-4 min-w-[80px] justify-end">
                                <span class="font-black text-lg">${Math.round(day.main.temp)}°</span>
                                <span class="text-slate-500 font-bold text-lg">${Math.round(day.main.temp - 5)}°</span>
                            </div>
                        `;
                        dailyForecastEl.appendChild(item);
                    });

                } catch (error) {
                    console.error('Fehler beim Laden des Wetters:', error);
                    locationNameEl.textContent = "Fehler!";
                }
            }

            async function loadInitialCity() {
                const savedCity = JSON.parse(localStorage.getItem('last_city'));
                if (savedCity) {
                    fetchAndProcessWeather(savedCity);
                } else {
                    // Default to Augsburg if no history
                    fetchAndProcessWeather({ name: 'Augsburg', lat: 48.3705, lon: 10.8978 });
                }
            }

            // Event Listeners
            openSearchBtn.addEventListener('click', () => toggleSearchbar(true));
            closeSearchBtn.addEventListener('click', () => toggleSearchbar(false));
            refreshBtn.addEventListener('click', () => {
                if (lastLocationData) fetchAndProcessWeather(lastLocationData);
            });

            async function fetchAndRenderSuggestions(query) {
                if (query.length < 3) {
                    suggestionsContainerEl.classList.add('hidden');
                    return;
                }

                const response = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${query}&limit=5&appid=${API_KEY}`);
                const results = await response.json();

                if (results.length > 0) {
                    suggestionsContainerEl.innerHTML = '';
                    results.forEach(result => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.className = 'p-4 border-b border-slate-700 hover:bg-slate-700 cursor-pointer flex justify-between items-center';
                        suggestionItem.innerHTML = `
                            <div>
                                <p class="font-bold text-white">${result.name}</p>
                                <p class="text-xs text-slate-400">${result.state ? result.state + ', ' : ''}${result.country}</p>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                        `;
                        suggestionItem.addEventListener('click', async () => {
                            cityInputEl.value = result.name;
                            suggestionsContainerEl.classList.add('hidden');
                            await fetchAndProcessWeather(result);
                            saveRecentCities(result);
                            toggleSearchbar(false);
                        });
                        suggestionsContainerEl.appendChild(suggestionItem);
                    });
                    suggestionsContainerEl.classList.remove('hidden');
                } else {
                    suggestionsContainerEl.classList.add('hidden');
                }
            }

            cityInputEl.addEventListener('input', debounce((e) => {
                fetchAndRenderSuggestions(e.target.value);
            }, 300));

            document.addEventListener('click', (e) => {
                if (!cityInputEl.contains(e.target) && !suggestionsContainerEl.contains(e.target)) {
                    suggestionsContainerEl.classList.add('hidden');
                }
            });

            loadInitialCity();
            
            // AUTOMATISCHES REFRESH-INTERVALL VON 5 MINUTEN (300000ms) AUF 30 MINUTEN (1800000ms) GEÄNDERT
            setInterval(() => {
                if (lastLocationData) {
                    console.log(`Aktualisiere Wetterdaten für ${lastLocationData.name} automatisch...`);
                    fetchAndProcessWeather(lastLocationData);
                }
            }, 1800000); 

            // Service Worker Registrierung
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(function(err) {
                    /* Fehler unterdrückt */
                });
            }
        });
    </script>
</body>
</html>
